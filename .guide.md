# @Codable Macro 支援 Enum 實作指南

## 一、任務概述

擴展 @Codable macro 支援所有 Swift Codable 可用的 enum 類型。

## 二、支援的 Enum 類型

### 2.1 Simple Enum（無 Raw Value、無 Associated Values）
```swift
@Codable
enum Direction {
    case north, south, east, west
}
// 編碼為字串: "north", "south" 等
```

### 2.2 Enum with Associated Values
```swift
@Codable
enum NetworkResponse {
    case success(data: Data, statusCode: Int)
    case failure(error: String)
    case empty
}
// 編碼為: {"success": {"data": "...", "statusCode": 200}}
```

### 2.3 Enum with Raw Value
```swift
enum Color: String, Codable {
    case red, green, blue
}
// Swift 自動符合 Codable，macro 應偵測並提供診斷訊息
```

## 三、實作步驟（TDD）

### 階段 1：修改現有架構支援 Enum（Red Phase）

#### 1.1 撰寫測試案例
- [ ] 測試：Simple enum 展開
- [ ] 測試：Associated values enum 展開
- [ ] 測試：Raw value enum 診斷訊息
- [ ] 測試：錯誤案例（non-Codable 關聯值）

#### 1.2 修改型別檢查邏輯
**檔案：** `Sources/CodableMacroMacros/CodableMacro.swift`

```swift
// 修改 expansion 函式中的型別檢查（第 17 行）
guard declaration.is(StructDeclSyntax.self) ||
      declaration.is(ClassDeclSyntax.self) ||
      declaration.is(EnumDeclSyntax.self) else {
    throw CodableMacroError.onlyApplicableToStructsAndClasses
}
```

#### 1.3 新增 Enum 分析邏輯
**新增檔案：** `Sources/CodableMacroMacros/EnumAnalyzer.swift`

```swift
import SwiftSyntax

enum EnumType {
    case simple              // 純 case
    case rawValue           // 有原始值
    case associatedValues   // 有關聯值
}

struct EnumCaseInfo {
    let name: String
    let parameters: [EnumParameterInfo]
}

struct EnumParameterInfo {
    let label: String?      // 參數標籤（可能為 nil）
    let type: String        // 參數型別
}

extension CodableMacro {
    static func analyzeEnum(_ declaration: EnumDeclSyntax) -> EnumType {
        // 1. 檢查 raw value
        // 2. 檢查 associated values
        // 3. 返回對應類型
    }

    static func extractEnumCases(from declaration: EnumDeclSyntax) throws -> [EnumCaseInfo] {
        // 提取所有 case 和參數資訊
    }
}
```

### 階段 2：實作 Simple Enum 支援（Green Phase）

#### 2.1 實作程式碼生成器
**新增檔案：** `Sources/CodableMacroMacros/EnumCodeGenerator.swift`

```swift
extension CodableMacro {
    static func generateSimpleEnumCodable(cases: [EnumCaseInfo]) throws -> [DeclSyntax] {
        var members: [DeclSyntax] = []

        // 1. 生成 CodingKeys（可選）
        // 2. 生成 init(from decoder:)
        // 3. 生成 encode(to:)

        return members
    }
}
```

**生成 init(from:) 範例：**
```swift
init(from decoder: Decoder) throws {
    let container = try decoder.singleValueContainer()
    let value = try container.decode(String.self)

    switch value {
    case "north": self = .north
    case "south": self = .south
    // ...
    default:
        throw DecodingError.dataCorrupted(
            DecodingError.Context(
                codingPath: decoder.codingPath,
                debugDescription: "Invalid enum case: \\(value)"
            )
        )
    }
}
```

#### 2.2 執行測試
```bash
swift test
```

### 階段 3：實作 Associated Values Enum 支援

#### 3.1 實作程式碼生成器
```swift
extension CodableMacro {
    static func generateAssociatedValuesEnumCodable(cases: [EnumCaseInfo]) throws -> [DeclSyntax] {
        var members: [DeclSyntax] = []

        // 1. 生成主 CodingKeys
        members.append(generateMainCodingKeys(cases: cases))

        // 2. 為每個有參數的 case 生成對應的 CodingKeys
        for caseInfo in cases where !caseInfo.parameters.isEmpty {
            members.append(generateCaseCodingKeys(for: caseInfo))
        }

        // 3. 生成 init(from:)
        members.append(generateAssociatedValuesInit(cases: cases))

        // 4. 生成 encode(to:)
        members.append(generateAssociatedValuesEncode(cases: cases))

        return members
    }
}
```

**生成巢狀 CodingKeys 範例：**
```swift
enum CodingKeys: String, CodingKey {
    case success
    case failure
    case empty
}

enum SuccessCodingKeys: String, CodingKey {
    case data
    case statusCode
}

enum FailureCodingKeys: String, CodingKey {
    case error
}
```

#### 3.2 處理無標籤參數
```swift
// 輸入：case success(String, Int)
// 生成：
enum SuccessCodingKeys: String, CodingKey {
    case _0  // String
    case _1  // Int
}
```

### 階段 4：Raw Value Enum 處理

#### 4.1 偵測並提供診斷
```swift
static func checkRawValueEnum(_ declaration: EnumDeclSyntax, context: some MacroExpansionContext) {
    if hasRawValue(declaration) {
        // 提供診斷訊息
        context.diagnose(Diagnostic(
            node: declaration,
            message: CodableMacroDiagnostic.enumWithRawValueDoesNotNeedMacro
        ))
    }
}
```

#### 4.2 不產生程式碼
返回空陣列 `[]` 即可。

### 階段 5：整合與重構

#### 5.1 修改主 expansion 函式
```swift
public static func expansion(
    of node: AttributeSyntax,
    providingMembersOf declaration: some DeclGroupSyntax,
    conformingTo protocols: [TypeSyntax],
    in context: some MacroExpansionContext
) throws -> [DeclSyntax] {

    // 根據型別分發到不同處理邏輯
    if let enumDecl = declaration.as(EnumDeclSyntax.self) {
        return try handleEnum(enumDecl, in: context)
    } else if let structDecl = declaration.as(StructDeclSyntax.self) {
        return try handleStruct(structDecl, in: context)
    } else if let classDecl = declaration.as(ClassDeclSyntax.self) {
        return try handleClass(classDecl, in: context)
    } else {
        throw CodableMacroError.unsupportedType
    }
}

static func handleEnum(_ declaration: EnumDeclSyntax, in context: some MacroExpansionContext) throws -> [DeclSyntax] {
    let enumType = analyzeEnum(declaration)

    switch enumType {
    case .rawValue:
        checkRawValueEnum(declaration, context: context)
        return []  // 不產生程式碼

    case .simple:
        let cases = try extractEnumCases(from: declaration)
        return try generateSimpleEnumCodable(cases: cases)

    case .associatedValues:
        let cases = try extractEnumCases(from: declaration)
        return try generateAssociatedValuesEnumCodable(cases: cases)
    }
}
```

## 四、測試策略

### 4.1 測試案例分類

#### Simple Enum 測試
```swift
@Test("Simple enum - 基本功能")
func testSimpleEnum() throws {
    assertMacroExpansion(
        """
        @Codable
        enum Direction {
            case north
            case south
            case east
            case west
        }
        """,
        expandedSource: """
        enum Direction {
            case north
            case south
            case east
            case west

            init(from decoder: Decoder) throws {
                let container = try decoder.singleValueContainer()
                let value = try container.decode(String.self)

                switch value {
                case "north": self = .north
                case "south": self = .south
                case "east": self = .east
                case "west": self = .west
                default:
                    throw DecodingError.dataCorrupted(
                        DecodingError.Context(
                            codingPath: decoder.codingPath,
                            debugDescription: "Invalid enum case: \\(value)"
                        )
                    )
                }
            }

            func encode(to encoder: Encoder) throws {
                var container = encoder.singleValueContainer()

                switch self {
                case .north: try container.encode("north")
                case .south: try container.encode("south")
                case .east: try container.encode("east")
                case .west: try container.encode("west")
                }
            }
        }

        extension Direction: Codable {
        }
        """,
        macros: ["Codable": CodableMacro.self]
    )
}
```

#### Associated Values Enum 測試
```swift
@Test("Associated values enum - 有標籤參數")
func testAssociatedValuesEnumWithLabels() throws {
    // 測試有標籤的關聯值
}

@Test("Associated values enum - 無標籤參數")
func testAssociatedValuesEnumWithoutLabels() throws {
    // 測試無標籤的關聯值（使用 _0, _1）
}

@Test("Associated values enum - 混合案例")
func testAssociatedValuesEnumMixed() throws {
    // 測試混合有/無參數的 case
}
```

#### Raw Value Enum 測試
```swift
@Test("Raw value enum - 應該提供診斷訊息")
func testRawValueEnum() throws {
    assertMacroExpansion(
        """
        @Codable
        enum Color: String {
            case red
            case green
            case blue
        }
        """,
        expandedSource: """
        enum Color: String {
            case red
            case green
            case blue
        }

        extension Color: Codable {
        }
        """,
        diagnostics: [
            DiagnosticSpec(
                message: "Enum with raw value already conforms to Codable",
                line: 1,
                column: 1,
                severity: .warning
            )
        ],
        macros: ["Codable": CodableMacro.self]
    )
}
```

### 4.2 手動編碼/解碼測試

在 `TestExample.swift` 中新增實際的編碼/解碼測試：

```swift
@Test("手動驗證 Simple Enum 編碼解碼")
func testSimpleEnumCodable() throws {
    enum Direction: Codable {
        case north, south, east, west

        // ... macro 生成的程式碼
    }

    let direction = Direction.north
    let encoder = JSONEncoder()
    let data = try encoder.encode(direction)
    let jsonString = String(data: data, encoding: .utf8)!

    #expect(jsonString == "\"north\"")

    let decoder = JSONDecoder()
    let decoded = try decoder.decode(Direction.self, from: data)
    #expect(decoded == .north)
}
```

## 五、執行檢查清單

### 每個階段完成後：
- [ ] 所有新增測試通過
- [ ] 既有測試仍然通過
- [ ] `swift build` 成功無警告
- [ ] 程式碼符合 Swift 風格指南
- [ ] 刪除所有未使用的程式碼和 import
- [ ] 函式簽章簡短且清晰
- [ ] 沒有變數使用底線開頭命名

### 最終檢查：
- [ ] 所有 14 個既有測試 + 新增測試全部通過
- [ ] README.md 更新，包含 enum 範例
- [ ] Examples.swift 新增 enum 範例
- [ ] CLAUDE.md 更新支援的型別說明
- [ ] 所有 Todo 完成
- [ ] 執行 `swift build` 和 `swift test` 確認無錯誤

## 六、注意事項

1. **不影響既有功能**：struct 和 class 的測試必須保持通過
2. **錯誤訊息清晰**：使用繁體中文或英文，描述具體問題
3. **程式碼重用**：抽取共用邏輯到獨立函式
4. **型別安全**：避免字串硬編碼，使用強型別
5. **測試驅動**：先寫測試，確認失敗，再實作，確認通過
