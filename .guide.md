# @Codable Macro Dictionary 轉換功能實作指南

## 任務目標

為 @Codable macro 新增四個字典轉換方法：
- `static func fromDict(_ dict: [String: Any]) throws -> Self`
- `static func fromDictArray(_ array: [[String: Any]]) throws -> [Self]`
- `func toDict() throws -> [String: Any]`
- `static func toDictArray(_ array: [Self]) throws -> [[String: Any]]`

## TDD 實作流程

### 階段 1：準備工作（Red Phase 前）

1. **更新 macro 定義**
   - 檔案：`Sources/CodableMacro/CodableMacro.swift`
   - 在 `@attached(member, names:)` 新增四個方法名稱

2. **新增錯誤型別**
   - 檔案：`Sources/CodableMacroMacros/CodableMacro.swift`
   - 在 `// MARK: - 錯誤處理` 區段新增 `DictConversionError`

### 階段 2：Red Phase - 先寫測試

**測試檔案**：`Tests/CodableMacroTests/CodableMacroTests.swift`

撰寫測試順序：

3. **Struct 基本功能測試**
   - 測試名稱：`testStructDictConversion()`
   - 驗證四個方法都正確生成

4. **Optional 型別測試**
   - 測試名稱：`testDictConversionWithOptional()`
   - 驗證 Optional 屬性處理

5. **Class 型別測試**
   - 測試名稱：`testClassDictConversion()`
   - 驗證 class 的 required init

6. **Simple Enum 測試**
   - 測試名稱：`testSimpleEnumDictConversion()`
   - 驗證 simple enum 支援

7. **Associated Values Enum 測試**
   - 測試名稱：`testAssociatedValuesEnumDictConversion()`
   - 驗證巢狀結構處理

8. **空 Struct 測試**
   - 測試名稱：`testEmptyStructDictConversion()`
   - 驗證邊界案例

9. **執行測試確認失敗**
   - 執行 `swift test`
   - 確認所有新測試都失敗（因為還沒實作）

### 階段 3：Green Phase - 實作功能

**實作檔案**：`Sources/CodableMacroMacros/CodableMacro.swift`

10. **實作四個生成器函式**
    - `generateFromDictMethod()`
    - `generateFromDictArrayMethod()`
    - `generateToDictMethod()`
    - `generateToDictArrayMethod()`
    - 位置：`// MARK: - 程式碼生成器` 區段

11. **整合到 handleStruct()**
    - 在 `handleStruct()` 末尾新增四個方法
    - 順序：CodingKeys → init → encode → 字典方法

12. **整合到 handleClass()**
    - 在 `handleClass()` 末尾新增四個方法
    - 邏輯與 struct 相同

13. **整合到 handleEnum()**
    - 在 simple 和 associatedValues 分支新增四個方法
    - rawValue 分支不產生（已有 warning）

14. **執行測試**
    - 執行 `swift test`
    - 確認所有測試通過

### 階段 4：執行期測試

15. **新增執行期往返測試**
    - 測試名稱：`testRoundTripDictConversion()`
    - 驗證 fromDict → toDict 往返正確

16. **新增執行期陣列測試**
    - 測試名稱：`testArrayConversion()`
    - 驗證陣列方法正確性

17. **新增執行期 Optional 測試**
    - 測試名稱：`testOptionalProperties()`
    - 驗證 nil 值處理

18. **新增執行期錯誤測試**
    - 測試名稱：`testErrorHandling()`
    - 驗證缺少欄位、型別錯誤等情況

19. **執行所有測試**
    - 執行 `swift test`
    - 確認所有測試通過

### 階段 5：Refactor Phase - 重構與優化

20. **程式碼檢查**
    - 檢查是否有重複程式碼
    - 檢查命名是否符合規範
    - 檢查是否有未使用的變數或 import

21. **執行 build**
    - 執行 `swift build`
    - 確保無錯誤、無警告

### 階段 6：文件更新

22. **更新 CLAUDE.md**
    - 新增字典轉換功能說明
    - 更新測試策略

23. **更新 README.md**
    - 新增使用範例
    - 更新功能特色

24. **更新 Examples.swift**
    - 新增字典轉換範例程式碼
    - 展示實際使用方式

### 階段 7：最終驗證

25. **完整測試**
    - 執行 `swift test`
    - 確認所有測試（包含原有測試）都通過

26. **建置驗證**
    - 執行 `swift build`
    - 確保專案能正常建置

27. **功能驗證**
    - 檢查所有四個方法都正確生成
    - 檢查 struct、class、enum 都支援
    - 檢查錯誤處理正確

## 實作細節

### 生成器模板

```swift
// generateFromDictMethod()
static func fromDict(_ dict: [String: Any]) throws -> Self {
    let jsonData = try JSONSerialization.data(withJSONObject: dict, options: [])
    let decoder = JSONDecoder()
    return try decoder.decode(Self.self, from: jsonData)
}

// generateFromDictArrayMethod()
static func fromDictArray(_ array: [[String: Any]]) throws -> [Self] {
    try array.map { dict in
        try fromDict(dict)
    }
}

// generateToDictMethod()
func toDict() throws -> [String: Any] {
    let encoder = JSONEncoder()
    let jsonData = try encoder.encode(self)
    guard let dict = try JSONSerialization.jsonObject(with: jsonData, options: []) as? [String: Any] else {
        throw DictConversionError.invalidDictionaryStructure
    }
    return dict
}

// generateToDictArrayMethod()
static func toDictArray(_ array: [Self]) throws -> [[String: Any]] {
    try array.map { instance in
        try instance.toDict()
    }
}
```

### 錯誤型別定義

```swift
enum DictConversionError: Error, CustomStringConvertible {
    case invalidDictionaryStructure

    var description: String {
        switch self {
        case .invalidDictionaryStructure:
            return "JSON object is not a valid dictionary structure"
        }
    }
}
```

## 檢查清單

### 程式碼實作
- [ ] 更新 macro 定義新增四個方法名稱
- [ ] 新增 DictConversionError 錯誤型別
- [ ] 實作 generateFromDictMethod()
- [ ] 實作 generateFromDictArrayMethod()
- [ ] 實作 generateToDictMethod()
- [ ] 實作 generateToDictArrayMethod()
- [ ] 修改 handleStruct() 整合方法
- [ ] 修改 handleClass() 整合方法
- [ ] 修改 handleEnum() 整合方法

### 測試實作
- [ ] Struct 基本功能測試
- [ ] Optional 型別測試
- [ ] Class 型別測試
- [ ] Simple Enum 測試
- [ ] Associated Values Enum 測試
- [ ] 空 Struct 測試
- [ ] 執行期往返測試
- [ ] 執行期陣列測試
- [ ] 執行期 Optional 測試
- [ ] 執行期錯誤測試

### 品質檢查
- [ ] swift build 無錯誤
- [ ] swift test 所有測試通過
- [ ] 程式碼風格符合規範
- [ ] 無未使用的程式碼
- [ ] 命名符合 Swift API Design Guidelines

### 文件更新
- [ ] 更新 CLAUDE.md
- [ ] 更新 README.md
- [ ] 更新 Examples.swift

## 注意事項

1. **TDD 流程嚴格執行**：先寫測試，確認失敗，再實作，確認通過
2. **錯誤處理**：所有錯誤一律 throw，不使用預設值
3. **程式碼重用**：利用現有 Codable 實作，透過 JSONSerialization 橋接
4. **命名規範**：遵循專案既有命名模式（generate*, handle*, extract*）
5. **無底線開頭變數**：絕對禁止使用 `_variable` 命名
6. **函式簽章**：簡短簽章不換行，保持程式碼緊湊
